# MyNFTMarketV4 Gas Report V2 (优化后)

## 测试结果概览
- 总测试数: 12 个
- 通过: 12 个
- 失败: 0 个
- 跳过: 0 个

## 各测试用例 Gas 消耗对比

| 测试用例 | V1 (优化前) | V2 (优化后) | 节省 Gas | 节省比例 |
|---------|-------------|-------------|----------|----------|
| testBuy1155NFT() | 400,404 | 398,940 | 1,464 | 0.37% |
| testBuy721NFT() | 423,161 | 421,054 | 2,107 | 0.50% |
| testCancelListing() | 292,215 | 291,487 | 728 | 0.25% |
| testCreate1155Listing() | 263,058 | 262,338 | 720 | 0.27% |
| testCreate721Listing() | 265,890 | 265,167 | 723 | 0.27% |
| testPermitBuyWithWhitelist() | 428,323 | 426,566 | 1,757 | 0.41% |
| testPlatformFee() | 456,449 | 454,837 | 1,612 | 0.35% |
| testRevertIfBuyOwnNFT() | 272,325 | 271,621 | 704 | 0.26% |
| testRevertIfDuplicateListing() | 265,039 | 264,341 | 698 | 0.26% |
| testRevertIfInsufficientPayment() | 279,437 | 278,745 | 692 | 0.25% |
| testRevertIfInvalidSignature() | 313,957 | 313,259 | 698 | 0.22% |
| testRevertIfNonOwnerCancel() | 267,497 | 266,781 | 716 | 0.27% |

## MyNFTMarketV4 合约详细 Gas 报告对比

### 部署成本对比
| 指标 | V1 (优化前) | V2 (优化后) | 节省 | 节省比例 |
|------|-------------|-------------|------|----------|
| **部署成本** | 2,430,250 gas | 2,310,750 gas | 119,500 gas | **4.92%** |
| **部署大小** | 11,707 bytes | 11,161 bytes | 546 bytes | **4.67%** |

### 函数调用 Gas 消耗对比

| 函数名 | V1 平均值 | V2 平均值 | 节省 Gas | 节省比例 |
|--------|-----------|-----------|----------|----------|
| PERMIT_TYPEHASH | 238 | 238 | 0 | 0% |
| buyNFT | 84,198 | 83,654 | 544 | **0.65%** |
| cancelListing | 34,850 | 34,838 | 12 | 0.03% |
| create1155Listing | 222,673 | 221,978 | 695 | **0.31%** |
| create721Listing | 205,328 | 204,693 | 635 | **0.31%** |
| feeReceiver | 2,629 | 2,629 | 0 | 0% |
| getNFTListing | 20,572 | 20,547 | 25 | **0.12%** |
| getUserListings | 25,037 | 24,716 | 321 | **1.28%** |
| hashTypedDataV4 | 522 | 522 | 0 | 0% |
| nonces | 2,605 | 2,605 | 0 | 0% |
| permitBuy | 116,647 | 116,118 | 529 | **0.45%** |
| setFeeReceiver | 30,690 | 30,690 | 0 | 0% |
| setPlatformFeePercentage | 47,159 | 47,159 | 0 | 0% |

## 优化措施总结

### 1. 存储布局优化
- **重新排列 Listing 结构体字段**：将相同大小的字段组合在一起，减少存储槽的使用
- **移除默认值初始化**：将 `platformFeePercentage = 0` 改为不初始化，节省部署 gas

### 2. 存储操作优化
- **使用 storage 引用替代结构体构造**：在 `create721Listing` 和 `create1155Listing` 中直接操作存储，避免临时结构体创建
- **缓存存储变量**：在 `_processPurchase` 中缓存频繁访问的存储变量，减少 SLOAD 操作

### 3. 计算优化
- **条件化手续费计算**：仅在 `platformFeePercentage > 0` 时计算手续费，避免不必要的计算
- **使用 unchecked 块**：在安全的循环递增/递减操作中使用 unchecked，节省溢出检查

### 4. 循环优化
- **提前退出条件**：在 `getUserListings` 和 `getLatestListings` 中添加提前退出条件
- **优化循环变量操作**：使用 unchecked 块进行循环变量的递增/递减

## 关键性能提升

### 最显著的改进
1. **部署成本降低 4.92%**：从 2,430,250 降至 2,310,750 gas
2. **合约大小减少 4.67%**：从 11,707 降至 11,161 bytes
3. **getUserListings 函数优化 1.28%**：从 25,037 降至 24,716 gas
4. **buyNFT 函数优化 0.65%**：从 84,198 降至 83,654 gas

### 总体效果
- **所有测试用例都有 gas 节省**：平均节省 0.25% - 0.50%
- **核心函数优化明显**：create 和 buy 函数都有显著改进
- **部署成本大幅降低**：节省近 12 万 gas，对于合约部署非常有价值

## 进一步优化建议

1. **事件优化**：考虑减少事件中的参数数量或使用 indexed 参数
2. **批量操作**：添加批量创建 listing 或批量购买的功能
3. **存储打包**：进一步优化小数据类型的存储打包
4. **函数选择器优化**：重新排列函数顺序以优化常用函数的选择器